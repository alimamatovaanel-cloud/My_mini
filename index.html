<!DOCTYPE html>
<html>
<head>
    <title>Регистрация EMIN</title>
    <script src="telegram.org"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 40px 20px; }
        .container { max-width: 400px; margin: auto; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        #status { margin-top: 20px; color: green; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <h2>Привет!</h2>
    <p id="greeting">Чтобы получить уникальный код EMIN и зарегистрироваться, нажмите кнопку ниже.</p>
    
    <button onclick="requestPhoneNumber()">Поделиться номером</button>
    
    <div id="status"></div>
</div>

<script>
    // *** ВАЖНО: Замените на свою ссылку из Google Apps Script ***
    const GOOGLE_SCRIPT_URL = "YOUR_GOOGLE_SCRIPT_URL";

    const tg = window.Telegram.WebApp;
    tg.ready(); // Сообщаем Телеграму, что приложение готово

    function requestPhoneNumber() {
        // Проверяем, есть ли пользовательские данные от Телеграма
        if (!tg.initDataUnsafe.user) {
            document.getElementById('status').innerText = 'Ошибка: Не могу получить данные пользователя.';
            return;
        }

        // В Mini App нет прямой функции "запросить номер через кнопку", 
        // но мы можем использовать встроенную кнопку "MainButton" для имитации процесса.
        // Реальный запрос номера обычно делается через Bot API в самом чате бота.

        // В этом упрощенном варианте мы берем имя и просим пользователя использовать стандартную кнопку Telegram
        const user = tg.initDataUnsafe.user;
        const firstName = user.first_name || 'Аноним';
        const phone = 'Телефон не получен в Mini App'; // Здесь мы не можем получить телефон без доп. API бота

        document.getElementById('greeting').innerText = `Здравствуйте, ${firstName}!`;
        sendDataToGoogleScript(firstName, phone);
    }

    function sendDataToGoogleScript(name, phone) {
        document.getElementById('status').innerText = 'Отправляем данные в таблицу...';
        const url = `${GOOGLE_SCRIPT_URL}?name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`;
        
        fetch(url)
            .then(response => response.text())
            .then(code => {
                document.getElementById('status').innerHTML = `✅ **Готово!** Ваш код: **${code}**.<br>Данные записаны в таблицу.`;
                document.querySelector('button').style.display = 'none'; // Скрываем кнопку
                tg.close(); // Закрываем Mini App автоматически
            })
            .catch(error => {
                document.getElementById('status').innerText = 'Произошла ошибка при получении кода.';
            });
    }
</script>
</body>
</html>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxsHfwbe9WpJrdQfc52g1J0jy_i3gMX6ICoqJrAYYJKToBSPN2ruRJEqhA_hUsNjVQA/exec";

    const tg = window.Telegram.WebApp;
    tg.ready(); 

    // Функция запускается сразу при открытии Mini App
    window.onload = function() {
        const statusDiv = document.getElementById('status');
        
        if (!tg.initDataUnsafe.user) {
            statusDiv.innerText = 'Ошибка: Откройте через приложение Telegram.';
            return;
        }

        const user = tg.initDataUnsafe.user;
        const firstName = user.first_name || 'Аноним';
        const phonePlaceholder = 'Телефон не получен';
        const chatId = user.id; // *** Получаем ID чата пользователя ***

        statusDiv.innerText = 'Отправляем данные в таблицу и боту...';

        // *** Добавляем chat_id в URL запроса ***
        const url = `${GOOGLE_SCRIPT_URL}?name=${encodeURIComponent(firstName)}&phone=${encodeURIComponent(phonePlaceholder)}&chat_id=${encodeURIComponent(chatId)}`;
        
        fetch(url)
            .then(response => response.text())
            .then(code => {
                statusDiv.innerHTML = `✅ **Готово!** Ваш код: **${code}**. <br><br> Бот отправит его вам в чат.`;
                tg.close(); 
            })
            .catch(error => {
                statusDiv.innerText = 'Произошла ошибка при отправке.';
            });
    }
